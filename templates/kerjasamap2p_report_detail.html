{% extends 'base.html' %}

{% block title %}Detail Laporan Kerjasama P2P - {{ pjp_name }} ({{ report_data.get('Nama Periode Laporan', 'N/A') }}/{{ report_data.get('Tahun Laporan', 'N/A') }}){% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Tombol Kembali ke Dashboard Kerjasama P2P -->
    <div class="mb-6">
        <a href="{{ url_for('kerjasamap2p_report', sandi=sandi_pjp) }}" class="inline-flex items-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left mr-2">
                <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
            </svg>
            Kembali ke Dashboard Kerjasama P2P
        </a>
    </div>

    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Detail Laporan Kerjasama P2P</h1>
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">{{ pjp_name }} (Sandi: {{ sandi_pjp }})</h2>
    <h3 class="text-xl font-medium text-gray-600 mb-8 text-center">Periode: {{ report_data.get('Nama Periode Laporan', 'N/A') }} {{ report_data.get('Tahun Laporan', 'N/A') }}</h3>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Left Column: Report Details & Visualizations -->
        <div class="lg:w-1/2 flex flex-col space-y-8">
            <!-- Bagian Informasi Laporan -->
            <div class="bg-white rounded-lg shadow-lg p-6 flex-grow">
                <h4 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Informasi Laporan</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                    <div>
                        <p><span class="font-semibold">Nomor Surat:</span> {{ report_data.get('Nomor Surat', 'N/A') }}</p>
                        <p><span class="font-semibold">Tanggal Surat:</span> {{ report_data.get('Tanggal Surat', 'N/A') }}</p>
                        <p><span class="font-semibold">Jumlah Perusahaan Kerjasama P2P:</span> {{ report_data.get('Jumlah Perusahaan Kerjasama P2P', 0) }}</p>
                        <p><span class="font-semibold">Created at:</span> {{ report_data.get('Created at', 'N/A') }}</p>
                    </div>
                </div>
            </div>

            <!-- Bagian Detail Perusahaan Kerjasama P2P -->
            <div class="bg-white rounded-lg shadow-lg p-6 flex-grow">
                <h4 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Detail Perusahaan Kerjasama</h4>
                {% if report_data.get('Perusahaan Kerjasama P2P') %}
                    <div class="space-y-4">
                        {% for coop in report_data['Perusahaan Kerjasama P2P'] %}
                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <p><span class="font-semibold">Nama Perusahaan:</span> {{ coop.get('Nama Perusahaan Kerjasama', 'N/A') }}</p>
                                <p><span class="font-semibold">Peran PJP:</span> {{ coop.get('Peran PJP', 'N/A') }}</p>
                                <p><span class="font-semibold">Tanggal Mulai:</span> {{ coop.get('Tanggal Mulai Kerjasama', 'N/A') }}</p>
                                <p><span class="font-semibold">Tanggal Akhir:</span> {{ coop.get('Tanggal Akhir Kerjasama', 'N/A') }}</p>
                                <p><span class="font-semibold">Keterangan:</span> {{ coop.get('Keterangan', 'N/A') }}</p>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-600 text-center">Tidak ada detail perusahaan kerjasama yang tersedia.</p>
                {% endif %}
            </div>

            <!-- Visualisasi Perbandingan 5 Bulan Terakhir -->
            <div class="bg-white rounded-lg shadow-lg p-6 flex-grow">
                <h4 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Tren Jumlah Kerjasama (5 Bulan Terakhir)</h4>
                <div class="w-full h-64">
                    <canvas id="cooperationTrend5MonthsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Right Column: Dokumen Laporan (PDF Viewer) and Yearly Comparison -->
        <div class="lg:w-1/2 flex flex-col space-y-8">
            <!-- Visualisasi Perbandingan Tahunan (Bulan yang Sama) -->
            <div class="bg-white rounded-lg shadow-lg p-6 flex-grow">
                <h4 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">
                    Perbandingan Tahunan (Bulan {{ report_data.get('Nama Periode Laporan', 'N/A') }} Saja)
                </h4>
                <div class="w-full h-64">
                    <canvas id="yearlyComparisonChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 flex-grow">
                <h4 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Dokumen Laporan</h4>
                {% if report_data.get('File URL') and report_data.get('File URL') != '#' %}
                    <div class="w-full h-[700px] bg-gray-200 rounded-lg overflow-hidden">
                        <iframe src="{{ report_data.get('File URL') }}" class="w-full h-full border-none"></iframe>
                    </div>
                    <p class="text-sm text-gray-600 mt-2 text-center">
                        Jika dokumen tidak tampil di atas, Anda bisa <a href="{{ report_data.get('File URL') }}" target="_blank" class="text-blue-500 hover:underline">mengunduh atau melihatnya di tab baru</a>.
                    </p>
                {% else %}
                    <p class="text-gray-600 text-center">Tidak ada dokumen PDF yang tersedia untuk laporan ini.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse JSON data passed from Flask
        // 'report_data' is now passed as a dictionary for Jinja, but we need to parse its JSON string representation for JS.
        const report = JSON.parse('{{ report_data | tojson | safe }}');
        const comparisonData5Months = JSON.parse('{{ comparison_data_5_months | safe }}');
        const comparisonSameMonthYearly = JSON.parse('{{ comparison_same_month_yearly | safe }}');

        // Helper to get month name from month number/name
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        function getMonthName(monthNumStr) {
            const monthMap = {
                "01": "Januari", "02": "Februari", "03": "Maret", "04": "April", "05": "Mei", "06": "Juni",
                "07": "Juli", "08": "Agustus", "09": "September", "10": "Oktober", "11": "November", "12": "Desember",
                "Januari": "Januari", "Februari": "Februari", "Maret": "Maret", "April": "April", "Mei": "Mei", "Juni": "Juni",
                "Juli": "Juli", "Agustus": "Agustus", "September": "September", "Oktober": "Oktober", "November": "November", "Desember": "Desember",
                "TW1": "TW1", "TW2": "TW2", "TW3": "TW3", "TW4": "TW4"
            };
            return monthMap[monthNumStr] || monthNumStr;
        }

        // Helper to convert month name to number (for sorting)
        function getMonthNumber(monthName) {
            const monthNameToNum = {
                "Januari": 1, "Februari": 2, "Maret": 3, "April": 4, "Mei": 5, "Juni": 6,
                "Juli": 7, "Agustus": 8, "September": 9, "Oktober": 10, "November": 11, "Desember": 12,
                "01": 1, "02": 2, "03": 3, "04": 4, "05": 5, "06": 6,
                "07": 7, "08": 8, "09": 9, "10": 10, "11": 11, "12": 12,
                "TW1": 1, "TW2": 4, "TW3": 7, "TW4": 10
            };
            return monthNameToNum[monthName] || 0;
        }

        // --- Grafik Garis: Tren Jumlah Kerjasama (5 Bulan Terakhir) ---
        const labels5Months = comparisonData5Months.map(d => `${getMonthName(d['Periode Laporan'])} ${d['Tahun Laporan']}`);
        const jumlahCooperation5Months = comparisonData5Months.map(d => d['Jumlah Perusahaan Kerjasama P2P']);

        const currentReportLabel = `${getMonthName(report['Periode Laporan'])} ${report['Tahun Laporan']}`;
        const currentReportIndex5Months = labels5Months.indexOf(currentReportLabel);

        const pointStyle5Months = new Array(labels5Months.length).fill('circle');
        const pointRadius5Months = new Array(labels5Months.length).fill(3);
        const pointBackgroundColor = new Array(labels5Months.length).fill('rgb(75, 192, 192)');
        const pointBorderColor = new Array(labels5Months.length).fill('rgb(75, 192, 192)');

        if (currentReportIndex5Months !== -1) {
            pointStyle5Months[currentReportIndex5Months] = 'star';
            pointRadius5Months[currentReportIndex5Months] = 8;
            pointBackgroundColor[currentReportIndex5Months] = 'rgb(255, 205, 86)';
            pointBorderColor[currentReportIndex5Months] = 'rgb(255, 159, 64)';
        }

        const ctx5Months = document.getElementById('cooperationTrend5MonthsChart').getContext('2d');
        new Chart(ctx5Months, {
            type: 'line',
            data: {
                labels: labels5Months,
                datasets: [
                    {
                        label: 'Jumlah Kerjasama P2P',
                        data: jumlahCooperation5Months,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: (context) => {
                            const index = context.dataIndex;
                            if (index === currentReportIndex5Months) {
                                return 'rgba(75, 192, 192, 0.5)';
                            }
                            return 'rgba(75, 192, 192, 0.0)';
                        },
                        tension: 0.1,
                        yAxisID: 'y-jumlah',
                        pointStyle: pointStyle5Months,
                        radius: pointRadius5Months,
                        pointBackgroundColor: pointBackgroundColor,
                        pointBorderColor: pointBorderColor,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (context.dataIndex === currentReportIndex5Months) {
                                    return `Jumlah Kerjasama Periode Ini: ${context.raw}`;
                                } else {
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        }
                    }
                },
                scales: {
                    'y-jumlah': {
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Jumlah Kerjasama P2P'
                        },
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // --- Grafik Batang: Perbandingan Tahunan (Bulan yang Sama) ---
        const yearlyLabels = [];
        const yearlyDataCooperation = [];

        // Add previous year data if available
        if (comparisonSameMonthYearly.previous_year_report) {
            yearlyLabels.push(`Tahun Lalu (${comparisonSameMonthYearly.previous_year_report['Tahun Laporan']})`);
            yearlyDataCooperation.push(comparisonSameMonthYearly.previous_year_report['Jumlah Perusahaan Kerjasama P2P'] || 0);
        }
        
        // Add current year data
        yearlyLabels.push(`Tahun Sekarang (${comparisonSameMonthYearly.current_year_report['Tahun Laporan']})`);
        yearlyDataCooperation.push(comparisonSameMonthYearly.current_year_report['Jumlah Perusahaan Kerjasama P2P'] || 0);


        const backgroundColorYearly = new Array(yearlyLabels.length).fill('rgba(54, 162, 235, 0.7)');
        const borderColorYearly = new Array(yearlyLabels.length).fill('rgba(54, 162, 235, 1)');

        const currentReportYearIndex = yearlyLabels.indexOf(`Tahun Sekarang (${comparisonSameMonthYearly.current_year_report['Tahun Laporan']})`);
        if (currentReportYearIndex !== -1) {
            backgroundColorYearly[currentReportYearIndex] = 'rgba(0, 128, 0, 0.9)'; // Highlight current year in green
            borderColorYearly[currentReportYearIndex] = 'rgba(255, 255, 255, 1)';
        }

        const ctxYearly = document.getElementById('yearlyComparisonChart').getContext('2d');
        new Chart(ctxYearly, {
            type: 'bar',
            data: {
                labels: yearlyLabels,
                datasets: [
                    {
                        label: 'Jumlah Kerjasama P2P',
                        data: yearlyDataCooperation,
                        backgroundColor: backgroundColorYearly,
                        borderColor: borderColorYearly,
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (context.dataIndex === currentReportYearIndex) {
                                    return `Jumlah Kerjasama Periode Ini: ${context.raw}`;
                                } else {
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tahun Laporan'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Jumlah Kerjasama P2P'
                        },
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
