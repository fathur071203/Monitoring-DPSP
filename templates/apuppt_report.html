{% extends 'base.html' %}

{% block title %}Dashboard Laporan APU PPT - {{ pjp_name }}{% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Tombol Kembali ke Detail PJP -->
    <div class="mb-6">
        <a href="{{ url_for('show_pjp_detail', sandi=sandi_pjp) }}" class="inline-flex items-center bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left mr-2">
                <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
            </svg>
            Kembali ke Detail PJP
        </a>
    </div>

    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Dashboard Laporan APU PPT Tahunan</h1>
    <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">{{ pjp_name }} (Sandi: {{ sandi_pjp }})</h2>

    <!-- A. FILTER PANEL -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8 flex flex-wrap items-center justify-center gap-4">
        <div class="flex flex-col">
            <label for="startYear" class="text-sm font-medium text-gray-700 mb-1">Tahun Awal:</label>
            <select id="startYear" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                {# Options populated by JavaScript #}
            </select>
        </div>
        <div class="flex flex-col">
            <label for="endYear" class="text-sm font-medium text-gray-700 mb-1">Tahun Akhir:</label>
            <select id="endYear" class="p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                {# Options populated by JavaScript #}
            </select>
        </div>
        <button id="applyFilterBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
            Terapkan Filter
        </button>
        <button id="resetFilterBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
            Reset Filter
        </button>
        <div class="flex items-center">
            <input type="checkbox" id="showInsightCheckbox" class="form-checkbox h-5 w-5 text-blue-600 rounded">
            <label for="showInsightCheckbox" class="ml-2 text-gray-700">Tampilkan Insight Otomatis</label>
        </div>
    </div>

    <!-- B. KPI CARD SECTION -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8">
        <div class="bg-blue-100 border-b-4 border-blue-500 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center text-center">
            <p class="text-sm font-medium text-blue-700">Total LTKT</p>
            <p id="kpiTotalLtkt" class="text-3xl font-bold text-blue-900 mt-1">0</p>
        </div>
        <div class="bg-green-100 border-b-4 border-green-500 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center text-center">
            <p class="text-sm font-medium text-green-700">Total LTKM</p>
            <p id="kpiTotalLtkm" class="text-3xl font-bold text-green-900 mt-1">0</p>
        </div>
        <div class="bg-red-100 border-b-4 border-red-500 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center text-center">
            <p class="text-sm font-medium text-red-700">Total LTKL</p>
            <p id="kpiTotalLtkl" class="text-3xl font-bold text-red-900 mt-1">0</p>
        </div>
        <div class="bg-purple-100 border-b-4 border-purple-500 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center text-center">
            <p class="text-sm font-medium text-purple-700">Laporan SIPESAT (%)</p>
            <p id="kpiSipesatPercentage" class="text-3xl font-bold text-purple-900 mt-1">0%</p>
        </div>
        <div class="bg-orange-100 border-b-4 border-orange-500 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center text-center">
            <p class="text-sm font-medium text-orange-700">Pemblokiran DTTOT (%)</p>
            <p id="kpiDttotPercentage" class="text-3xl font-bold text-orange-900 mt-1">0%</p>
        </div>
        <div class="bg-teal-100 border-b-4 border-teal-500 rounded-lg shadow-lg p-4 flex flex-col items-center justify-center text-center">
            <p class="text-sm font-medium text-teal-700">Pemblokiran DPPSPM (%)</p>
            <p id="kpiDppspmPercentage" class="text-3xl font-bold text-teal-900 mt-1">0%</p>
        </div>
    </div>

    <!-- C. VISUALISASI UTAMA (Tren) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Tren Laporan LTKT, LTKM, LTKL Tahunan</h3>
            <div class="w-full h-80">
                <canvas id="ltktLtkmLtklTrendChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Tren Status Laporan SIPESAT Triwulanan</h3>
            <div class="w-full h-80">
                <canvas id="sipesatTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- New Charts for more insights -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Tren Laporan Pemblokiran DTTOT Tahunan</h3>
            <div class="w-full h-80">
                <canvas id="dttotPemblokiranTrendChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Tren Laporan Pemblokiran DPPSPM Tahunan</h3>
            <div class="w-full h-80">
                <canvas id="dppspmPemblokiranTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Komposisi Laporan SIPESAT (Tahun Terbaru) -->
    <div class="grid grid-cols-1 lg:grid-cols-1 gap-8 mb-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Komposisi Status Laporan SIPESAT (Tahun Terbaru)</h3>
            <div class="w-full h-80">
                <canvas id="sipesatCompositionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- NEW: Upload Status Map -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Status Unggah Laporan APU PPT Tahunan</h3>
        <div class="overflow-x-auto">
            <table id="uploadStatusTable" class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">Tahun Laporan</th>
                        <th class="py-3 px-6 text-center">Status Unggah</th>
                        <th class="py-3 px-6 text-center">Tanggal Unggah</th>
                        <th class="py-3 px-6 text-center">Jatuh Tempo</th>
                        <th class="py-3 px-6 text-center">Keterlambatan (Hari)</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700 text-sm">
                    <!-- Upload status rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- F. AUTO GENERATED INSIGHT -->
    <div id="autoInsightSection" class="bg-white rounded-lg shadow-lg p-6 mb-8 hidden">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Ringkasan dan Anomali Otomatis</h3>
        <p id="summaryInsight" class="text-lg text-gray-600 leading-relaxed">
            <!-- Dynamic insight text will be generated here by JavaScript -->
        </p>
    </div>

    <!-- Section 2: Tabel Laporan APU PPT Tahunan -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Daftar Laporan APU PPT Tahunan</h3>
        <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mb-4">
            Export ke Excel
        </button>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">Tahun</th>
                        <th class="py-3 px-6 text-left">LTKT</th>
                        <th class="py-3 px-6 text-left">LTKM</th>
                        <th class="py-3 px-6 text-left">LTKL</th>
                        <th class="py-3 px-6 text-left">SIPESAT Lapor</th>
                        <th class="py-3 px-6 text-left">DTTOT Lapor</th>
                        <th class="py-3 px-6 text-left">DPPSPM Lapor</th>
                        <th class="py-3 px-6 text-left">Aksi</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody" class="text-gray-700 text-sm">
                    <!-- Reports will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

{# Script tags for robust JSON passing #}
<script type="application/json" id="initial-dashboard-data-apuppt">
    {{ initial_dashboard_data_apuppt | tojson | safe }}
</script>
<script type="application/json" id="available-years-apuppt">
    {{ available_years | tojson | safe }}
</script>
<script type="application/json" id="kpis-apuppt">
    {{ kpis | tojson | safe }}
</script>
<script type="application/json" id="annual-upload-status-apuppt">
    {{ annual_upload_status_apuppt | tojson | safe }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script type="text/javascript">
    // Global variables for charts to allow updating them
    let ltktLtkmLtklTrendChartInstance;
    let sipesatTrendChartInstance;
    let dttotPemblokiranTrendChartInstance;
    let dppspmPemblokiranTrendChartInstance;
    let sipesatCompositionChartInstance;

    // Data from Flask backend
    let allApuPptReports;
    let availableYearsInitial;
    let kpisInitial;
    let annualUploadStatusData;

    try {
        allApuPptReports = JSON.parse(document.getElementById('initial-dashboard-data-apuppt').textContent.trim());
        console.log("Parsed allApuPptReports:", allApuPptReports);
    } catch (e) {
        console.error("Error parsing allApuPptReports JSON:", e);
        allApuPptReports = [];
    }

    try {
        availableYearsInitial = JSON.parse(document.getElementById('available-years-apuppt').textContent.trim());
        console.log("Parsed availableYearsInitial (APU PPT):", availableYearsInitial);
    } catch (e) {
        console.error("Error parsing availableYearsInitial (APU PPT) JSON:", e);
        availableYearsInitial = [];
    }

    try {
        kpisInitial = JSON.parse(document.getElementById('kpis-apuppt').textContent.trim());
        console.log("Parsed kpisInitial (APU PPT):", kpisInitial);
    } catch (e) {
        console.error("Error parsing kpisInitial (APU PPT) JSON:", e);
        kpisInitial = {};
    }

    try {
        annualUploadStatusData = JSON.parse(document.getElementById('annual-upload-status-apuppt').textContent.trim());
        console.log("Parsed annualUploadStatusData (APU PPT):", annualUploadStatusData);
    } catch (e) {
        console.error("Error parsing annualUploadStatusData (APU PPT) JSON:", e);
        annualUploadStatusData = {};
    }

    // Variable to store currently filtered data for export
    let currentFilteredReports = [];

    // Helper to format numbers (for counts)
    function formatNumber(amount) {
        return new Intl.NumberFormat('id-ID').format(amount);
    }

    // Function to populate year dropdowns
    function populateYearDropdowns() {
        const startYearSelect = document.getElementById('startYear');
        const endYearSelect = document.getElementById('endYear');

        const uniqueYears = [...new Set(allApuPptReports.map(report => report["tahun_laporan"]))].sort((a, b) => a - b);

        startYearSelect.innerHTML = '';
        endYearSelect.innerHTML = '';

        if (uniqueYears.length > 0) {
            uniqueYears.forEach(year => {
                const optionStart = document.createElement('option');
                optionStart.value = year;
                optionStart.textContent = year;
                startYearSelect.appendChild(optionStart);

                const optionEnd = document.createElement('option');
                optionEnd.value = year;
                optionEnd.textContent = year;
                endYearSelect.appendChild(optionEnd);
            });
            startYearSelect.value = uniqueYears[0];
            endYearSelect.value = uniqueYears[uniqueYears.length - 1];
            startYearSelect.disabled = false;
            endYearSelect.disabled = false;
        } else {
            startYearSelect.innerHTML = '<option value="">Tidak ada tahun</option>';
            endYearSelect.innerHTML = '<option value="">Tidak ada tahun</option>';
            startYearSelect.disabled = true;
            endYearSelect.disabled = true;
        }
    }

    // Main function to filter data and render all dashboard components
    function renderDashboard() {
        const startYear = parseInt(document.getElementById('startYear').value);
        const endYear = parseInt(document.getElementById('endYear').value);

        let filteredReports = allApuPptReports.filter(report => {
            const reportYear = parseInt(report["tahun_laporan"]);
            return reportYear >= startYear && reportYear <= endYear;
        });

        // Sort by year
        filteredReports.sort((a, b) => a["tahun_laporan"] - b["tahun_laporan"]);

        currentFilteredReports = filteredReports;

        console.log("DEBUG JS: filteredReports in renderDashboard:", filteredReports);

        updateKPIs(filteredReports);
        updateCharts(filteredReports);
        updateSipesatCompositionChart(filteredReports); // New chart call
        updateUploadStatusTable();
        updateReportsTable(filteredReports);
        generateSummaryInsight(filteredReports);
    }

    // B. KPI CARD SECTION Update
    function updateKPIs(data) {
        const totalLtkt = data.reduce((sum, report) => sum + (report.jumlah_ltkt || 0), 0);
        const totalLtkm = data.reduce((sum, report) => sum + (report.jumlah_ltkm || 0), 0);
        const totalLtkl = data.reduce((sum, report) => sum + (report.jumlah_ltkl || 0), 0);
        
        let totalSipesatUploaded = 0;
        let totalSipesatExpected = 0;
        let totalDttotPemblokiranReported = 0;
        let totalDttotPemblokiranExpected = 0;
        let totalDppspmPemblokiranReported = 0;
        let totalDppspmPemblokiranExpected = 0;

        data.forEach(report => {
            totalSipesatUploaded += (report.sipesat_uploaded_count || 0);
            totalSipesatExpected += (report.sipesat_expected_count || 0);
            totalDttotPemblokiranReported += (report.jumlah_lapor_pemblokiran_dttot || 0);
            totalDttotPemblokiranExpected += (report.expected_lapor_pemblokiran_dttot || 0);
            totalDppspmPemblokiranReported += (report.jumlah_lapor_pemblokiran_dppspm || 0);
            totalDppspmPemblokiranExpected += (report.expected_lapor_pemblokiran_dppspm || 0);
        });

        const sipesatPercentage = (totalSipesatExpected > 0) ? (totalSipesatUploaded / totalSipesatExpected * 100) : 0;
        const dttotPercentage = (totalDttotPemblokiranExpected > 0) ? (totalDttotPemblokiranReported / totalDttotPemblokiranExpected * 100) : 0;
        const dppspmPercentage = (totalDppspmPemblokiranExpected > 0) ? (totalDppspmPemblokiranReported / totalDppspmPemblokiranExpected * 100) : 0;


        document.getElementById('kpiTotalLtkt').textContent = formatNumber(totalLtkt);
        document.getElementById('kpiTotalLtkm').textContent = formatNumber(totalLtkm);
        document.getElementById('kpiTotalLtkl').textContent = formatNumber(totalLtkl);
        document.getElementById('kpiSipesatPercentage').textContent = `${sipesatPercentage.toFixed(2)}%`;
        document.getElementById('kpiDttotPercentage').textContent = `${dttotPercentage.toFixed(2)}%`;
        document.getElementById('kpiDppspmPercentage').textContent = `${dppspmPercentage.toFixed(2)}%`;
    }

    // C. VISUALISASI UTAMA (Tren) Update
    function updateCharts(data) {
        const chartLabels = data.map(report => report.tahun_laporan);
        
        // Data for LTKT, LTKM, LTKL Trend Chart
        const ltktData = data.map(report => report.jumlah_ltkt || 0);
        const ltkmData = data.map(report => report.jumlah_ltkm || 0);
        const ltklData = data.map(report => report.jumlah_ltkl || 0);

        if (ltktLtkmLtklTrendChartInstance) { ltktLtkmLtklTrendChartInstance.destroy(); }
        const ctx1 = document.getElementById('ltktLtkmLtklTrendChart').getContext('2d');
        ltktLtkmLtklTrendChartInstance = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    { label: 'LTKT', data: ltktData, borderColor: 'rgb(75, 192, 192)', fill: false, tension: 0.1 },
                    { label: 'LTKM', data: ltkmData, borderColor: 'rgb(255, 159, 64)', fill: false, tension: 0.1 },
                    { label: 'LTKL', data: ltklData, borderColor: 'rgb(153, 102, 255)', fill: false, tension: 0.1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatNumber(context.raw)}` } } },
                scales: { x: { title: { display: true, text: 'Tahun Laporan' } }, y: { beginAtZero: true, title: { display: true, text: 'Jumlah Laporan' }, ticks: { callback: function(value) { return formatNumber(value); } } } }
            }
        });

        // Data for SIPESAT Trend Chart
        const sipesatTw1 = data.map(report => report.lapor_sipesat_tw1 ? 1 : 0);
        const sipesatTw2 = data.map(report => report.lapor_sipesat_tw2 ? 1 : 0);
        const sipesatTw3 = data.map(report => report.lapor_sipesat_tw3 ? 1 : 0);
        const sipesatTw4 = data.map(report => report.lapor_sipesat_tw4 ? 1 : 0);

        if (sipesatTrendChartInstance) { sipesatTrendChartInstance.destroy(); }
        const ctx2 = document.getElementById('sipesatTrendChart').getContext('2d');
        sipesatTrendChartInstance = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    { label: 'TW1', data: sipesatTw1, borderColor: 'rgb(54, 162, 235)', fill: false, tension: 0.1 },
                    { label: 'TW2', data: sipesatTw2, borderColor: 'rgb(34, 197, 94)', fill: false, tension: 0.1 },
                    { label: 'TW3', data: sipesatTw3, borderColor: 'rgb(239, 68, 68)', fill: false, tension: 0.1 },
                    { label: 'TW4', data: sipesatTw4, borderColor: 'rgb(255, 205, 86)', fill: false, tension: 0.1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${context.raw ? 'Lapor' : 'Tidak Lapor'}` } } },
                scales: { 
                    x: { title: { display: true, text: 'Tahun Laporan' } }, 
                    y: { 
                        beginAtZero: true, 
                        max: 1, 
                        stepSize: 1,
                        title: { display: true, text: 'Status Lapor (1=Ya, 0=Tidak)' },
                        ticks: { callback: function(value) { return value === 1 ? 'Ya' : 'Tidak'; } }
                    }
                }
            }
        });

        // Data for DTTOT Pemblokiran Trend Chart
        const dttotReported = data.map(report => report.jumlah_lapor_pemblokiran_dttot || 0);
        const dttotExpected = data.map(report => report.expected_lapor_pemblokiran_dttot || 0);

        if (dttotPemblokiranTrendChartInstance) { dttotPemblokiranTrendChartInstance.destroy(); }
        const ctx3 = document.getElementById('dttotPemblokiranTrendChart').getContext('2d');
        dttotPemblokiranTrendChartInstance = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [
                    { label: 'Dilaporkan', data: dttotReported, backgroundColor: 'rgba(75, 192, 192, 0.7)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 },
                    { label: 'Diharapkan', data: dttotExpected, backgroundColor: 'rgba(255, 99, 132, 0.7)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatNumber(context.raw)}` } } },
                scales: { x: { title: { display: true, text: 'Tahun Laporan' } }, y: { beginAtZero: true, title: { display: true, text: 'Jumlah Pemblokiran' }, ticks: { callback: function(value) { return formatNumber(value); } } } }
            }
        });

        // Data for DPPSPM Pemblokiran Trend Chart
        const dppspmReported = data.map(report => report.jumlah_lapor_pemblokiran_dppspm || 0);
        const dppspmExpected = data.map(report => report.expected_lapor_pemblokiran_dppspm || 0);

        if (dppspmPemblokiranTrendChartInstance) { dppspmPemblokiranTrendChartInstance.destroy(); }
        const ctx4 = document.getElementById('dppspmPemblokiranTrendChart').getContext('2d');
        dppspmPemblokiranTrendChartInstance = new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [
                    { label: 'Dilaporkan', data: dppspmReported, backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 },
                    { label: 'Diharapkan', data: dppspmExpected, backgroundColor: 'rgba(255, 205, 86, 0.7)', borderColor: 'rgba(255, 205, 86, 1)', borderWidth: 1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatNumber(context.raw)}` } } },
                scales: { x: { title: { display: true, text: 'Tahun Laporan' } }, y: { beginAtZero: true, title: { display: true, text: 'Jumlah Pemblokiran' }, ticks: { callback: function(value) { return formatNumber(value); } } } }
            }
        });
    }

    // Komposisi Status Laporan SIPESAT (Tahun Terbaru)
    function updateSipesatCompositionChart(data) {
        const latestReport = data.length > 0 ? data[data.length - 1] : {};

        const tw1Status = latestReport.lapor_sipesat_tw1 ? 1 : 0;
        const tw2Status = latestReport.lapor_sipesat_tw2 ? 1 : 0;
        const tw3Status = latestReport.lapor_sipesat_tw3 ? 1 : 0;
        const tw4Status = latestReport.lapor_sipesat_tw4 ? 1 : 0;

        const reportedCount = tw1Status + tw2Status + tw3Status + tw4Status;
        const notReportedCount = 4 - reportedCount; // Assuming 4 quarters expected

        if (sipesatCompositionChartInstance) { sipesatCompositionChartInstance.destroy(); }
        const ctx = document.getElementById('sipesatCompositionChart').getContext('2d');
        sipesatCompositionChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Dilaporkan', 'Belum Dilaporkan'],
                datasets: [{
                    data: [reportedCount, notReportedCount],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.7)',  // Green for Reported
                        'rgba(239, 68, 68, 0.7)'   // Red for Not Reported
                    ],
                    borderColor: [
                        'rgba(34, 197, 94, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { callbacks: { label: (context) => `${context.label}: ${formatNumber(context.raw)} (${(context.raw / (reportedCount + notReportedCount) * 100).toFixed(2)}%)` } }
                }
            }
        });
    }


    // Function to update the Annual Upload Status Table
    function updateUploadStatusTable() {
        const uploadStatusTableBody = document.getElementById('uploadStatusTable').querySelector('tbody');
        uploadStatusTableBody.innerHTML = '';

        const years = Object.keys(annualUploadStatusData)
            .map(key => parseInt(key))
            .filter((value, index, self) => self.indexOf(value) === index)
            .sort((a, b) => a - b);

        if (years.length === 0) {
            const noDataRow = document.createElement('tr');
            noDataRow.innerHTML = `<td colspan="5" class="py-3 px-6 text-center text-gray-500">Tidak ada data status unggah laporan APU PPT tahunan.</td>`;
            uploadStatusTableBody.appendChild(noDataRow);
            return;
        }

        years.forEach(year => {
            const periodKey = String(year);
            const status = annualUploadStatusData[periodKey];

            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50';

            const yearCell = document.createElement('td');
            yearCell.className = 'py-3 px-6 text-left font-semibold';
            yearCell.textContent = year;
            row.appendChild(yearCell);

            const statusCell = document.createElement('td');
            statusCell.className = 'py-3 px-6 text-center';
            let bgColor = 'bg-white';
            let statusText = '';
            let tooltipText = '';

            if (status) {
                if (status.uploaded) {
                    if (status.days_late > 0) {
                        bgColor = 'bg-orange-100';
                        statusText = `Terlambat (${status.days_late} hari)`;
                        tooltipText = `Diunggah: ${status.upload_date} (Terlambat ${status.days_late} hari)`;
                    } else {
                        bgColor = 'bg-green-100';
                        statusText = `Tepat Waktu`;
                        tooltipText = `Diunggah: ${status.upload_date} (Tepat Waktu)`;
                    }
                } else {
                    if (status.days_late !== null && status.days_late > 0) {
                        bgColor = 'bg-red-200';
                        statusText = `Belum Unggah (${status.days_late} hari)`;
                        tooltipText = `Belum Unggah. Terlambat ${status.days_late} hari. Jatuh Tempo: ${status.due_date}`;
                    } else {
                        bgColor = 'bg-gray-100';
                        statusText = 'Belum Unggah';
                        tooltipText = `Belum Unggah. Jatuh Tempo: ${status.due_date}`;
                    }
                }
            } else {
                statusText = 'N/A';
                tooltipText = 'Data status tidak tersedia';
            }
            statusCell.textContent = statusText;
            statusCell.classList.add(bgColor);
            statusCell.title = tooltipText;
            row.appendChild(statusCell);

            const uploadDateCell = document.createElement('td');
            uploadDateCell.className = 'py-3 px-6 text-center';
            uploadDateCell.textContent = status ? (status.upload_date || 'N/A') : 'N/A';
            row.appendChild(uploadDateCell);

            const dueDateCell = document.createElement('td');
            dueDateCell.className = 'py-3 px-6 text-center';
            dueDateCell.textContent = status ? (status.due_date || 'N/A') : 'N/A';
            row.appendChild(dueDateCell);

            const daysLateCell = document.createElement('td');
            daysLateCell.className = 'py-3 px-6 text-center';
            daysLateCell.textContent = status && status.days_late !== null ? `${status.days_late} hari` : 'N/A';
            row.appendChild(daysLateCell);

            uploadStatusTableBody.appendChild(row);
        });
    }


    // F. AUTO GENERATED INSIGHT (Anomaly Detection)
    function generateSummaryInsight(data) {
        const showInsight = document.getElementById('showInsightCheckbox').checked;
        const autoInsightSection = document.getElementById('autoInsightSection');
        const summaryInsightText = document.getElementById('summaryInsight');

        if (!showInsight) {
            autoInsightSection.classList.add('hidden');
            return;
        } else {
            autoInsightSection.classList.remove('hidden');
        }

        if (data.length === 0) {
            summaryInsightText.textContent = "Tidak ada data laporan APU PPT tahunan yang tersedia untuk periode filter ini.";
            return;
        }

        let insightHtml = `Analisis laporan APU PPT tahunan dari **${data[0].tahun_laporan}** hingga **${data[data.length - 1].tahun_laporan}** menunjukkan: <br><br>`;
        let anomalies = [];

        const ltktAnomalyThreshold = 200; // Example: more than 200 LTKT is an anomaly
        const sipesatCompletionThreshold = 0.9; // Below 90% SIPESAT completion is an anomaly
        const pemblokiranCompletionThreshold = 0.8; // Below 80% DTTOT/DPPSPM completion is an anomaly

        for (let i = 0; i < data.length; i++) {
            const report = data[i];
            const year = report.tahun_laporan;

            if (report.jumlah_ltkt > ltktAnomalyThreshold) {
                anomalies.push(`Pada tahun ${year}, **Jumlah LTKT** sangat tinggi yaitu **${formatNumber(report.jumlah_ltkt)}**, melebihi ambang batas normal (${ltktAnomalyThreshold}). Ini mungkin mengindikasikan peningkatan aktivitas transaksi mencurigakan.`);
            }

            const sipesatCompletionRate = (report.sipesat_expected_count > 0) ? (report.sipesat_uploaded_count / report.sipesat_expected_count) : 1;
            if (sipesatCompletionRate < sipesatCompletionThreshold) {
                anomalies.push(`Pada tahun ${year}, tingkat penyelesaian laporan SIPESAT adalah **${(sipesatCompletionRate * 100).toFixed(2)}%**, yang berada di bawah target ${sipesatCompletionThreshold * 100}%.`);
            }

            const dttotCompletionRate = (report.expected_lapor_pemblokiran_dttot > 0) ? (report.jumlah_lapor_pemblokiran_dttot / report.expected_lapor_pemblokiran_dttot) : 1;
            if (dttotCompletionRate < pemblokiranCompletionThreshold) {
                anomalies.push(`Pada tahun ${year}, tingkat penyelesaian laporan pemblokiran DTTOT adalah **${(dttotCompletionRate * 100).toFixed(2)}%**, yang berada di bawah target ${pemblokiranCompletionThreshold * 100}%.`);
            }

            const dppspmCompletionRate = (report.expected_lapor_pemblokiran_dppspm > 0) ? (report.jumlah_lapor_pemblokiran_dppspm / report.expected_lapor_pemblokiran_dppspm) : 1;
            if (dppspmCompletionRate < pemblokiranCompletionThreshold) {
                anomalies.push(`Pada tahun ${year}, tingkat penyelesaian laporan pemblokiran DPPSPM adalah **${(dppspmCompletionRate * 100).toFixed(2)}%**, yang berada di bawah target ${pemblokiranCompletionThreshold * 100}%.`);
            }
        }

        if (anomalies.length > 0) {
            insightHtml += `<p class="font-semibold text-red-700">Potensi Anomali Ditemukan:</p><ul>`;
            anomalies.forEach(anomaly => {
                insightHtml += `<li>${anomaly}</li>`;
            });
            insightHtml += `</ul><br>`;
            insightHtml += `**Rekomendasi Audit:** Disarankan untuk meninjau secara detail laporan-laporan yang ditandai dan proses kepatuhan APU PPT untuk memastikan kepatuhan penuh.`;
        } else {
            insightHtml += `<p class="text-green-700">Tidak ada anomali signifikan yang terdeteksi berdasarkan ambang batas yang ditetapkan pada laporan APU PPT.</p>`;
        }

        const latestReport = data[data.length - 1];
        insightHtml += `<br><p class="font-semibold">Ringkasan Laporan APU PPT Tahun ${latestReport.tahun_laporan}:</p>
            <ul>
                <li>Jumlah LTKT: **${formatNumber(latestReport.jumlah_ltkt || 0)}**</li>
                <li>Jumlah LTKM: **${formatNumber(latestReport.jumlah_ltkm || 0)}**</li>
                <li>Jumlah LTKL: **${formatNumber(latestReport.jumlah_ltkl || 0)}**</li>
                <li>Laporan SIPESAT Diselesaikan: **${formatNumber(latestReport.sipesat_uploaded_count || 0)} dari ${formatNumber(latestReport.sipesat_expected_count || 0)}**</li>
                <li>Laporan Pemblokiran DTTOT Diselesaikan: **${formatNumber(latestReport.jumlah_lapor_pemblokiran_dttot || 0)} dari ${formatNumber(latestReport.expected_lapor_pemblokiran_dttot || 0)}**</li>
                <li>Laporan Pemblokiran DPPSPM Diselesaikan: **${formatNumber(latestReport.jumlah_lapor_pemblokiran_dppspm || 0)} dari ${formatNumber(latestReport.expected_lapor_pemblokiran_dppspm || 0)}**</li>
            </ul>
            <br>
            <p>Laporan ini memberikan gambaran tentang kepatuhan terhadap regulasi APU PPT dan PPSPM, serta efektivitas dalam pelaporan transaksi mencurigakan dan pemblokiran dana terkait terorisme.</p>
        `;

        summaryInsightText.innerHTML = insightHtml;
    }

    // Update the list of reports table
    function updateReportsTable(data) {
        const reportsTableBody = document.getElementById('reportsTableBody');
        reportsTableBody.innerHTML = '';

        if (data.length === 0) {
            const noDataRow = document.createElement('tr');
            noDataRow.innerHTML = `<td colspan="8" class="py-3 px-6 text-center text-gray-500">Tidak ada laporan APU PPT tahunan yang tersedia untuk filter ini.</td>`;
            reportsTableBody.appendChild(noDataRow);
            return;
        }

        const sortedForTable = [...data].sort((a, b) => b["tahun_laporan"] - a["tahun_laporan"]); // Descending order (most recent first)

        const currentSandiPjp = "{{ sandi_pjp }}";

        sortedForTable.forEach(report => {
            const detailUrl = `/analisis_pjp/${currentSandiPjp}/apuppt_report_detail/${report['tahun_laporan']}`;

            row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50';

            row.innerHTML = `
                <td class="py-3 px-6 text-left whitespace-nowrap">${report['tahun_laporan']}</td>
                <td class="py-3 px-6 text-left">${formatNumber(report['jumlah_ltkt'] || 0)}</td>
                <td class="py-3 px-6 text-left">${formatNumber(report['jumlah_ltkm'] || 0)}</td>
                <td class="py-3 px-6 text-left">${formatNumber(report['jumlah_ltkl'] || 0)}</td>
                <td class="py-3 px-6 text-left">${formatNumber(report['sipesat_uploaded_count'] || 0)}/4</td>
                <td class="py-3 px-6 text-left">${formatNumber(report['jumlah_lapor_pemblokiran_dttot'] || 0)}/${formatNumber(report['expected_lapor_pemblokiran_dttot'] || 0)}</td>
                <td class="py-3 px-6 text-left">${formatNumber(report['jumlah_lapor_pemblokiran_dppspm'] || 0)}/${formatNumber(report['expected_lapor_pemblokiran_dppspm'] || 0)}</td>
                <td class="py-3 px-6 text-left">
                    <a href="${detailUrl}" class="text-blue-500 hover:underline">Lihat Detail</a>
                </td>
            `;
            reportsTableBody.appendChild(row);
        });
    }

    // Function to export filtered data to Excel
    function exportToExcel() {
        if (currentFilteredReports.length === 0) {
            showCustomAlert('Tidak ada data untuk diekspor. Harap filter data terlebih dahulu.');
            return;
        }

        const dataForExcel = currentFilteredReports.map(report => ({
            'Sandi PJP': "{{ sandi_pjp }}",
            'Nama PJP': "{{ pjp_name }}",
            'Tahun Laporan': report['tahun_laporan'],
            'Nomor Surat': report['nomor_surat'],
            'Tanggal Surat': report['tanggal_surat'],
            'Nama Petugas': report['nama_petugas'],
            'SK Penunjukan': report['sk_penunjukan'],
            'User ID GoAML': report['user_id_goaml'],
            'User ID SIPESAT': report['user_id_sipesat'],
            'User ID PEP': report['user_id_pep'],
            'User ID SIPENDAR': report['user_id_sipendar'],
            'Jumlah LTKT': report['jumlah_ltkt'],
            'Jumlah LTKM': report['jumlah_ltkm'],
            'Jumlah LTKL': report['jumlah_ltkl'],
            'Lapor SIPESAT TW1': report['lapor_sipesat_tw1'],
            'Lapor SIPESAT TW2': report['lapor_sipesat_tw2'],
            'Lapor SIPESAT TW3': report['lapor_sipesat_tw3'],
            'Lapor SIPESAT TW4': report['lapor_sipesat_tw4'],
            'Jumlah Lapor Pemblokiran DTTOT': report['jumlah_lapor_pemblokiran_dttot'],
            'Expected Lapor Pemblokiran DTTOT': report['expected_lapor_pemblokiran_dttot'],
            'Keterangan Lapor Pemblokiran DTTOT': report['keterangan_lapor_pemblokiran_dttot'],
            'Jumlah Lapor Pemblokiran DPPSPM': report['jumlah_lapor_pemblokiran_dppspm'],
            'Expected Lapor Pemblokiran DPPSPM': report['expected_lapor_pemblokiran_dppspm'],
            'Keterangan Lapor Pemblokiran DPPSPM': report['keterangan_lapor_pemblokiran_dppspm'],
            'Tanggung Jawab Direksi': report['tanggung_jawab_direksi'],
            'Kebijakan Prosedur': report['kebijakan_prosedur'],
            'Metode PMPJ': report['metode_pmpj'],
            'Manajemen Risiko': report['manajemen_risiko'],
            'Manajemen SDM': report['manajemen_sdm'],
            'Sistem Pengendalian': report['sistem_pengendalian'],
            'Nama Penginput': report['nama_penginput'],
            'Email Penginput': report['email_penginput'],
            'Email Perusahaan': report['email_perusahaan'],
            'Nomor HP': report['nomor_hp'],
            'File URL': report['file_url'],
            'File Path': report['file_path'],
            'Created At': report['created_at']
        }));

        const ws = XLSX.utils.json_to_sheet(dataForExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Laporan APU PPT Tahunan");

        const fileName = `Laporan_APUPPT_Tahunan_${"{{ pjp_name | replace(' ', '_') }}"}_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }

    // Custom Alert/Modal Function
    function showCustomAlert(message) {
        let alertModal = document.getElementById('customAlertModal');
        if (!alertModal) {
            alertModal = document.createElement('div');
            alertModal.id = 'customAlertModal';
            alertModal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden';
            alertModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <p id="customAlertMessage" class="text-gray-800 text-lg mb-4"></p>
                    <button id="customAlertCloseBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg float-right">OK</button>
                </div>
            `;
            document.body.appendChild(alertModal);

            document.getElementById('customAlertCloseBtn').addEventListener('click', () => {
                alertModal.classList.add('hidden');
            });
        }
        document.getElementById('customAlertMessage').textContent = message;
        alertModal.classList.remove('hidden');
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        populateYearDropdowns();
        
        // Populate initial KPIs using kpisInitial data directly from Flask
        if (Object.keys(kpisInitial).length > 0) {
            document.getElementById('kpiTotalLtkt').textContent = formatNumber(kpisInitial.total_ltkt || 0);
            document.getElementById('kpiTotalLtkm').textContent = formatNumber(kpisInitial.total_ltkm || 0);
            document.getElementById('kpiTotalLtkl').textContent = formatNumber(kpisInitial.total_ltkl || 0);
            document.getElementById('kpiSipesatPercentage').textContent = `${(kpisInitial.sipesat_percentage || 0).toFixed(2)}%`;
            document.getElementById('kpiDttotPercentage').textContent = `${(kpisInitial.dttot_percentage || 0).toFixed(2)}%`;
            document.getElementById('kpiDppspmPercentage').textContent = `${(kpisInitial.dppspm_percentage || 0).toFixed(2)}%`;
        } else {
            document.getElementById('kpiTotalLtkt').textContent = formatNumber(0);
            document.getElementById('kpiTotalLtkm').textContent = formatNumber(0);
            document.getElementById('kpiTotalLtkl').textContent = formatNumber(0);
            document.getElementById('kpiSipesatPercentage').textContent = `0.00%`;
            document.getElementById('kpiDttotPercentage').textContent = `0.00%`;
            document.getElementById('kpiDppspmPercentage').textContent = `0.00%`;
        }

        renderDashboard(); 

        document.getElementById('applyFilterBtn').addEventListener('click', renderDashboard);
        document.getElementById('resetFilterBtn').addEventListener('click', function() {
            populateYearDropdowns();
            document.getElementById('showInsightCheckbox').checked = false;
            renderDashboard();
        });

        document.getElementById('showInsightCheckbox').addEventListener('change', function() {
            renderDashboard();
        });

        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
    });
</script>
{% endblock %}